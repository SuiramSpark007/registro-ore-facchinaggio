<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Ore Facchinaggio</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="toast-container"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // Toast System
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        };

        const App = () => {
          const [currentSheet, setCurrentSheet] = useState({
            id: Date.now(),
            data: new Date().toISOString().split('T')[0],
            titoloAzienda: '',
            location: '',
            responsabile: '',
            note: '',
            lavoratori: [],
            firmaResponsabile: null,
            status: 'draft'
          });

          const [savedSheets, setSavedSheets] = useState([]);
          const [isAddingWorker, setIsAddingWorker] = useState(false);
          const [newWorker, setNewWorker] = useState({ 
            nome: '', 
            cognome: '', 
            oraIn: '', 
            oraOut: '',
            pausaMinuti: '',
            firma: null 
          });
          const [userRole, setUserRole] = useState('admin');
          
          const canvasRef = useRef(null);
          const respCanvasRef = useRef(null);
          const [isDrawing, setIsDrawing] = useState(false);
          const [currentSignature, setCurrentSignature] = useState('worker');

          const calculateHours = (oraIn, oraOut, pausaMinuti = 0) => {
            if (!oraIn || !oraOut) return '0.00';
            const [inH, inM] = oraIn.split(':').map(Number);
            const [outH, outM] = oraOut.split(':').map(Number);
            let diffMinutes = (outH * 60 + outM) - (inH * 60 + inM);
            if (diffMinutes < 0) diffMinutes += 24 * 60;
            diffMinutes -= parseInt(pausaMinuti) || 0;
            return Math.max(0, diffMinutes / 60).toFixed(2);
          };

          useEffect(() => {
            const saved = JSON.parse(localStorage.getItem('timesheets') || '[]');
            setSavedSheets(saved);
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'worker') {
              setUserRole('worker');
              const sheetId = urlParams.get('sheet');
              if (sheetId) {
                const existingSheet = saved.find(s => s.id.toString() === sheetId);
                if (existingSheet) setCurrentSheet(existingSheet);
              }
            }
          }, []);

          useEffect(() => {
            localStorage.setItem('timesheets', JSON.stringify(savedSheets));
          }, [savedSheets]);

          const initCanvas = (canvas) => {
            if (canvas) {
              const ctx = canvas.getContext('2d');
              ctx.fillStyle = '#ffffff';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
          };

          useEffect(() => {
            if (canvasRef.current) initCanvas(canvasRef.current);
            if (respCanvasRef.current) initCanvas(respCanvasRef.current);
          }, [isAddingWorker]);

          const getEventPos = (e, canvas) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = e.clientX || (e.touches?.[0]?.clientX) || 0;
            const clientY = e.clientY || (e.touches?.[0]?.clientY) || 0;
            return {
              x: (clientX - rect.left) * scaleX,
              y: (clientY - rect.top) * scaleY
            };
          };

          const startDrawing = (e) => {
            e.preventDefault();
            setIsDrawing(true);
            const canvas = currentSignature === 'worker' ? canvasRef.current : respCanvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const pos = getEventPos(e, canvas);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';
          };

          const draw = (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const canvas = currentSignature === 'worker' ? canvasRef.current : respCanvasRef.current;
            if (!canvas) return;
            const pos = getEventPos(e, canvas);
            canvas.getContext('2d').lineTo(pos.x, pos.y);
            canvas.getContext('2d').stroke();
          };

          const stopDrawing = (e) => {
            e.preventDefault();
            setIsDrawing(false);
          };

          const clearSignature = () => {
            const canvas = currentSignature === 'worker' ? canvasRef.current : respCanvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          };

          const saveWorkerSignature = () => {
            if (!canvasRef.current) return;
            const signatureData = canvasRef.current.toDataURL('image/png');
            setNewWorker(prev => ({ ...prev, firma: signatureData }));
            showToast('Firma salvata!', 'success');
          };

          const saveResponsabileSignature = () => {
            if (!respCanvasRef.current) return;
            const signatureData = respCanvasRef.current.toDataURL('image/png');
            setCurrentSheet(prev => ({ ...prev, firmaResponsabile: signatureData }));
            showToast('Firma responsabile salvata!', 'success');
          };

          const addWorker = () => {
            if (!newWorker.nome || !newWorker.cognome || !newWorker.oraIn || !newWorker.oraOut) {
              showToast('Compila tutti i campi obbligatori', 'error');
              return;
            }
            
            const oreTotali = calculateHours(newWorker.oraIn, newWorker.oraOut, newWorker.pausaMinuti);
            
            setCurrentSheet(prev => ({
              ...prev,
              lavoratori: [...prev.lavoratori, { ...newWorker, id: Date.now(), oreTotali }]
            }));
            
            setNewWorker({ nome: '', cognome: '', oraIn: '', oraOut: '', pausaMinuti: '', firma: null });
            setIsAddingWorker(false);
            showToast('Lavoratore aggiunto!', 'success');
          };

          const removeWorker = (workerId) => {
            setCurrentSheet(prev => ({
              ...prev,
              lavoratori: prev.lavoratori.filter(w => w.id !== workerId)
            }));
          };

          const completeSheet = () => {
            if (!currentSheet.responsabile || !currentSheet.firmaResponsabile || currentSheet.lavoratori.length === 0) {
              showToast('Compila tutti i campi e aggiungi lavoratori', 'error');
              return;
            }
            
            const completedSheet = { 
              ...currentSheet, 
              status: 'completed', 
              completedAt: new Date().toISOString() 
            };
            
            setSavedSheets(prev => {
              const filtered = prev.filter(s => s.id !== currentSheet.id);
              return [...filtered, completedSheet];
            });
            
            showToast('Foglio completato!', 'success');
            
            setCurrentSheet({
              id: Date.now(),
              data: new Date().toISOString().split('T')[0],
              titoloAzienda: '',
              location: '',
              responsabile: '',
              note: '',
              lavoratori: [],
              firmaResponsabile: null,
              status: 'draft'
            });
          };

          const generatePDF = async (sheet) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1000;
            canvas.height = 500 + (sheet.lavoratori.length * 140) + 250;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(0, 0, canvas.width, 120);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('REGISTRO ORE LAVORO', 50, 50);
            ctx.font = 'bold 24px Arial';
            ctx.fillText(sheet.titoloAzienda || 'AZIENDA', 50, 90);
            
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 18px Arial';
            let y = 160;
            ctx.fillText('Data: ' + sheet.data, 50, y);
            y += 30;
            ctx.fillText('Responsabile: ' + (sheet.responsabile || 'N/A'), 50, y);
            y += 30;
            ctx.fillText('Localita: ' + (sheet.location || 'N/A'), 50, y);
            y += 30;
            if (sheet.note) {
              ctx.font = '14px Arial';
              ctx.fillText('Note: ' + sheet.note, 50, y);
              y += 30;
            }
            
            y += 20;
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(50, y, 900, 40);
            ctx.fillStyle = '#ffffff';
            ctx.fillText('N', 65, y + 25);
            ctx.fillText('NOME COGNOME', 110, y + 25);
            ctx.fillText('ORA IN', 350, y + 25);
            ctx.fillText('ORA OUT', 450, y + 25);
            ctx.fillText('PAUSA', 560, y + 25);
            ctx.fillText('TOT ORE', 650, y + 25);
            ctx.fillText('FIRMA', 770, y + 25);
            y += 40;
            
            ctx.fillStyle = '#000000';
            ctx.font = '15px Arial';
            let totalOre = 0;
            
            for (let i = 0; i < sheet.lavoratori.length; i++) {
              const worker = sheet.lavoratori[i];
              const rowY = y + (i * 140);
              
              if (i % 2 === 0) {
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(50, rowY, 900, 140);
              }
              
              ctx.fillStyle = '#000000';
              ctx.font = 'bold 15px Arial';
              ctx.fillText((i + 1).toString(), 65, rowY + 30);
              ctx.font = '15px Arial';
              ctx.fillText(worker.nome + ' ' + worker.cognome, 110, rowY + 30);
              ctx.fillText(worker.oraIn, 350, rowY + 30);
              ctx.fillText(worker.oraOut, 450, rowY + 30);
              ctx.fillText((worker.pausaMinuti || '0') + 'min', 560, rowY + 30);
              ctx.font = 'bold 17px Arial';
              ctx.fillText(worker.oreTotali + 'h', 650, rowY + 30);
              totalOre += parseFloat(worker.oreTotali);
              
              if (worker.firma) {
                const img = new Image();
                img.src = worker.firma;
                await new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                ctx.drawImage(img, 770, rowY + 10, 140, 55);
              }
            }
            
            y += (sheet.lavoratori.length * 140) + 20;
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(50, y, 900, 50);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('TOTALE ORE: ' + totalOre.toFixed(2) + 'h', 350, y + 32);
            
            y += 80;
            if (sheet.firmaResponsabile) {
              ctx.fillStyle = '#000000';
              ctx.font = 'bold 18px Arial';
              ctx.fillText('FIRMA RESPONSABILE:', 50, y);
              y += 15;
              const respImg = new Image();
              respImg.src = sheet.firmaResponsabile;
              await new Promise(resolve => { respImg.onload = resolve; respImg.onerror = resolve; });
              ctx.drawImage(respImg, 50, y, 300, 110);
            }
            
            canvas.toBlob((blob) => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'Registro_' + (sheet.titoloAzienda || 'Ore') + '_' + sheet.data + '.png';
              a.click();
              URL.revokeObjectURL(url);
              showToast('Documento scaricato!', 'success');
            });
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                  <h1 className="text-3xl font-bold mb-6">⏰ Registro Presenze</h1>
                  
                  <div className="space-y-6">
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Titolo / Azienda</label>
                        <input
                          type="text"
                          value={currentSheet.titoloAzienda}
                          onChange={(e) => setCurrentSheet(prev => ({ ...prev, titoloAzienda: e.target.value }))}
                          placeholder="Es: Amazon, DHL"
                          className="w-full p-3 border rounded-lg"
                          disabled={userRole === 'worker'}
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-2">Data</label>
                        <input
                          type="date"
                          value={currentSheet.data}
                          onChange={(e) => setCurrentSheet(prev => ({ ...prev, data: e.target.value }))}
                          className="w-full p-3 border rounded-lg"
                        />
                      </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Responsabile</label>
                        <input
                          type="text"
                          value={currentSheet.responsabile}
                          onChange={(e) => setCurrentSheet(prev => ({ ...prev, responsabile: e.target.value }))}
                          placeholder="Nome responsabile"
                          className="w-full p-3 border rounded-lg"
                          disabled={userRole === 'worker'}
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-2">Località</label>
                        <input
                          type="text"
                          value={currentSheet.location}
                          onChange={(e) => setCurrentSheet(prev => ({ ...prev, location: e.target.value }))}
                          placeholder="Indirizzo"
                          className="w-full p-3 border rounded-lg"
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium mb-2">Note (opzionale)</label>
                      <textarea
                        value={currentSheet.note}
                        onChange={(e) => setCurrentSheet(prev => ({ ...prev, note: e.target.value }))}
                        placeholder="Es: Materiale scaricato, problemi..."
                        className="w-full p-3 border rounded-lg"
                        rows="3"
                      />
                    </div>

                    <div>
                      <div className="flex justify-between mb-4">
                        <h3 className="text-lg font-semibold">Lavoratori ({currentSheet.lavoratori.length})</h3>
                        <button
                          onClick={() => setIsAddingWorker(true)}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg"
                        >
                          + Aggiungi
                        </button>
                      </div>

                      {currentSheet.lavoratori.map((worker, i) => (
                        <div key={worker.id} className="bg-gray-50 p-4 rounded-lg mb-3 flex justify-between">
                          <div>
                            <p className="font-medium">{i + 1}. {worker.nome} {worker.cognome}</p>
                            <p className="text-sm text-gray-600">IN: {worker.oraIn} | OUT: {worker.oraOut} | Ore: {worker.oreTotali}h</p>
                          </div>
                          <button onClick={() => removeWorker(worker.id)} className="text-red-600">🗑️</button>
                        </div>
                      ))}
                    </div>

                    {isAddingWorker && (
                      <div className="bg-blue-50 p-6 rounded-lg">
                        <h4 className="font-semibold mb-4">Nuovo Lavoratore</h4>
                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                          <input
                            type="text"
                            value={newWorker.nome}
                            onChange={(e) => setNewWorker(prev => ({ ...prev, nome: e.target.value }))}
                            placeholder="Nome"
                            className="p-3 border rounded-lg"
                          />
                          <input
                            type="text"
                            value={newWorker.cognome}
                            onChange={(e) => setNewWorker(prev => ({ ...prev, cognome: e.target.value }))}
                            placeholder="Cognome"
                            className="p-3 border rounded-lg"
                          />
                        </div>
                        <div className="grid grid-cols-3 gap-4 mb-4">
                          <div>
                            <label className="block text-sm mb-2">Ora IN</label>
                            <input
                              type="time"
                              value={newWorker.oraIn}
                              onChange={(e) => setNewWorker(prev => ({ ...prev, oraIn: e.target.value }))}
                              className="w-full p-3 border rounded-lg"
                            />
                          </div>
                          <div>
                            <label className="block text-sm mb-2">Ora OUT</label>
                            <input
                              type="time"
                              value={newWorker.oraOut}
                              onChange={(e) => setNewWorker(prev => ({ ...prev, oraOut: e.target.value }))}
                              className="w-full p-3 border rounded-lg"
                            />
                          </div>
                          <div>
                            <label className="block text-sm mb-2">Pausa (min)</label>
                            <input
                              type="number"
                              value={newWorker.pausaMinuti}
                              onChange={(e) => setNewWorker(prev => ({ ...prev, pausaMinuti: e.target.value }))}
                              className="w-full p-3 border rounded-lg"
                            />
                          </div>
                        </div>

                        {newWorker.oraIn && newWorker.oraOut && (
                          <div className="mb-4 p-3 bg-blue-100 rounded">
                            <strong>Ore totali: {calculateHours(newWorker.oraIn, newWorker.oraOut, newWorker.pausaMinuti)}h</strong>
                          </div>
                        )}

                        <div className="mb-4">
                          <label className="block text-sm mb-2">Firma (opzionale)</label>
                          <canvas
                            ref={canvasRef}
                            width={400}
                            height={150}
                            onMouseDown={(e) => { setCurrentSignature('worker'); startDrawing(e); }}
                            onMouseMove={draw}
                            onMouseUp={stopDrawing}
                            onTouchStart={(e) => { setCurrentSignature('worker'); startDrawing(e); }}
                            onTouchMove={draw}
                            onTouchEnd={stopDrawing}
                            className="border rounded w-full bg-white"
                            style={{ touchAction: 'none' }}
                          />
                          <div className="flex gap-2 mt-2">
                            <button onClick={clearSignature} className="px-3 py-2 bg-gray-500 text-white rounded">Cancella</button>
                            <button onClick={saveWorkerSignature} className="px-3 py-2 bg-green-600 text-white rounded">Salva Firma</button>
                          </div>
                        </div>

                        <div className="flex gap-2">
                          <button onClick={addWorker} className="px-4 py-2 bg-green-600 text-white rounded-lg">Conferma</button>
                          <button onClick={() => setIsAddingWorker(false)} className="px-4 py-2 bg-gray-500 text-white rounded-lg">Annulla</button>
                        </div>
                      </div>
                    )}

                    {userRole === 'admin' && (
                      <div>
                        <label className="block text-sm font-medium mb-2">Firma Responsabile</label>
                        <canvas
                          ref={respCanvasRef}
                          width={400}
                          height={150}
                          onMouseDown={(e) => { setCurrentSignature('responsabile'); startDrawing(e); }}
                          onMouseMove={draw}
                          onMouseUp={stopDrawing}
                          onTouchStart={(e) => { setCurrentSignature('responsabile'); startDrawing(e); }}
                          onTouchMove={draw}
                          onTouchEnd={stopDrawing}
                          className="border rounded w-full bg-white"
                          style={{ touchAction: 'none' }}
                        />
                        <div className="flex gap-2 mt-2">
                          <button onClick={clearSignature} className="px-3 py-2 bg-gray-500 text-white rounded">Cancella</button>
                          <button onClick={saveResponsabileSignature} className="px-3 py-2 bg-green-600 text-white rounded">Salva Firma</button>
                        </div>
                      </div>
                    )}

                    <button
                      onClick={completeSheet}
                      className="w-full py-3 bg-green-600 text-white rounded-lg font-semibold"
                    >
                      ✅ Completa Foglio
                    </button>
                  </div>
                </div>

                {savedSheets.filter(s => s.status === 'completed').length > 0 && (
                  <div className="bg-white rounded-xl shadow-lg p-6">
                    <h2 className="text-2xl font-bold mb-4">📂 Registri Completati</h2>
                    {savedSheets.filter(s => s.status === 'completed').reverse().map(sheet => (
                      <div key={sheet.id} className="border rounded-lg p-4 mb-3 flex justify-between items-center">
                        <div>
                          <h3 className="font-semibold">{sheet.titoloAzienda || 'Senza titolo'}</h3>
                          <p className="text-sm text-gray-600">{sheet.data} - {sheet.lavoratori.length} lavoratori</p>
                        </div>
                        <button
                          onClick={() => generatePDF(sheet)}
                          className="px-4 py-2 bg-red-600 text-white rounded-lg"
                        >
                          📥 Scarica
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
